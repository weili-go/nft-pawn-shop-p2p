<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="./dependencies/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>è³ªå…¥ã‚Œã®NFTã®ãƒªã‚¹ãƒˆ</title>
</head>
<body>
  <h1 id="title">è³ªå…¥ã‚Œã®NFTã®ãƒªã‚¹ãƒˆ </h1>
  <div id="nftlist"></div>
</body>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/nedb/1.8.0/nedb.min.js"></script>
<script type="text/javascript" src="./dependencies/handlebars.min.js"></script>
<script type="text/javascript">
  window.addEventListener('load', (event) => {
    const nftListContainer = document.getElementById('nftlist');
    const nftListTemplate = Handlebars.compile(`
      {{#each this}}
      <div class="card">
        <h4> ğŸ“¢ è³ªå…¥ã‚ŒãŒã‚ã‚Š: {{ nt }}</h4>
        <label>èè³‡è€…ã‚¢ãƒ‰ãƒ¬ã‚¹: </label>&nbsp;<span>{{ borrower }}</span>
        <br />
        <label>æ‹…ä¿ã™ã‚‹NFTã®ã‚¢ãƒ‰ãƒ¬ã‚¹: </label>&nbsp;<span>{{ nftaddress }}</span>
        <br />
        <label>æ‹…ä¿ã™ã‚‹NFTã®ãƒˆãƒ¼ã‚¯ãƒ³ID: </label>&nbsp;<span>{{ nfttokenid }}</span>
        <br />
        <label>å¸Œæœ›ã®å€Ÿå…¥ERC20ãƒˆãƒ¼ã‚¯ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹: </label>&nbsp;<span>{{ loanERC20Denomination }}</span>
        <br />
        <label>å¸Œæœ›ã®å€Ÿå…¥ERC20é‡‘é¡: </label>&nbsp;<span>{{ loanPrincipalAmount }}</span>
        <br />
        <label>å¸Œæœ›ã®æœ€å¤§è¿”æ¸ˆé‡‘é¡: </label>&nbsp;<span>{{ maximumRepaymentAmount }}</span>
        <br />
        <label>å¸Œæœ›ã®å€Ÿå…¥æœŸé–“: </label>&nbsp;<span>{{ loanDuration }}</span>
        <br />
        <br />
        <a class="button" {{nosign}} href="/lender_lend_loan_sign.html?id={{ id }}">èè³‡ã®ã‚ªãƒ•ã‚¡ãƒ¼ã‚’å‡ºã™</a>
        <br />
        <a class="button" {{nosign2}} href="/lender_lend_loan_sign.html?id={{ id }}">å³æ™‚ã«å‡ºè³‡ã™ã‚‹</a>
        <br />
        <a class="button" href="/get_offers.html?id={{id}}">è©²å½“NFTã®è³ªå…¥ã‚Œã¸ã®ã‚ªãƒ•ã‚¡ãƒ¼ä¸€è¦§</a>
      </div>
    {{/each}}
    `);

    //db
    console.log('-------db');
    const filenamet = 'maintest1';

    var db = new Nedb({ filename: filenamet, autoload: true });

    db.find({}).sort({ nt: -1 }).exec(function (err, docs) {
      console.log(docs[0]);

      let nftlist = docs || [];
      let formattednftlist = [];
      nftlist.forEach((nft) => {

        formattednftlist.push({
          borrower: nft.borrower,
          borrowernonce: nft.borrowernonce,
          nftaddress: nft.nftaddress,
          nfttokenid: nft.nfttokenid,
          loanERC20Denomination: nft.loanERC20Denomination,
          loanPrincipalAmount: nft.loanPrincipalAmount,
          maximumRepaymentAmount: nft.maximumRepaymentAmount,
          loanDuration: nft.loanDuration,
          id: nft._id,
          nosign: nft.borrowersign == "" ? "disabled":"",
          nosign2: nft.borrowersign2 == "" ? "disabled":"",
          nt: nft.nt,
        });
      });

      console.log(formattednftlist);
      nftListContainer.innerHTML = nftListTemplate(formattednftlist);
    });
/*
    db.find({}, function (err, docs) {
      console.log(docs[0]);

      let nftlist = docs || [];
      let formattednftlist = [];
      nftlist.forEach((nft) => {

        formattednftlist.push({
          borrower: nft.borrower,
          borrowernonce: nft.borrowernonce,
          nftaddress: nft.nftaddress,
          nfttokenid: nft.nfttokenid,
          loanERC20Denomination: nft.loanERC20Denomination,
          loanPrincipalAmount: nft.loanPrincipalAmount,
          maximumRepaymentAmount: nft.maximumRepaymentAmount,
          loanDuration: nft.loanDuration,
          id: nft._id,
          nosign: nft.borrowersign == "" ? "disabled":"",
          nosign2: nft.borrowersign2 == "" ? "disabled":"",
          nt: nft.nt,
        });
      });

      console.log(formattednftlist);
      nftListContainer.innerHTML = nftListTemplate(formattednftlist);
    });
*/
    nftListContainer.innerHTML = '<p style="text-align:center;">Fetching NFTs list...</p>';
  });
</script>

</html>
